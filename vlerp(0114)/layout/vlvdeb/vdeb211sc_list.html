<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>购物车</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" type="text/css" href="../../css/common/mui.css" />
		<link rel="stylesheet" type="text/css" href="../../css/common/app.css" />
		<link rel="stylesheet" href="../../css/fonts/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="../../css/index.css" />
		<style>
			.mui-row:before,
			.mui-row:after {
				display: none;
			}
			.mui-table-view:after,
			.mui-table-view:before,
			.mui-table-view-cell:after{
				height: 0;
			}
			input{
				padding:0 !important;margin:0 !important;
			}
			input[placeholder]{
				font-size: 12px !important;
			}
			.mask{
				position: fixed;
			    top: 0;
			    right: 0;
			    bottom: 0;
			    left: 0;
				background-color: #000;
				background-color:rgba(0, 0, 0, .8);
				filter:Alpha(opacity=50);
				z-index: 1000;
				display: none;
			}
			.mask-tip{
				position: absolute;
				top:100px;
				left:50%;
				width:300px;
				margin-left:-150px;
				background-color:white;
				border-radius: 10px;
			}
			.mask-title{
				padding: 10px;
				border-bottom: 1px dashed #6C6C6C;
			}
			.mask-content{
				height: 300px;
				overflow: hidden;
			}
			.mask-btn{
				padding: 10px 10px;
				border-top: 1px dashed #6C6C6C;
				text-align: center;
			}
			.mask-btn-item{
				margin-bottom:10px;
			}
			/**/
			.mui-backdrop {
			    position: fixed;
			    top: 0;
			    right: 0;
			    bottom: 0;
			    left: 0;
			    z-index: 998;
			    background-color: rgba(0,0,0,.8);
			    
			}
			/**/
			.Mlist{padding-top:5px;background:#fff;margin-bottom: 3px;border-radius:10px;position: relative;}
			.Dlist{padding:0;margin:0;background:#f6f6f6;margin-bottom:2px;border-radius:5px;position: relative;}
			.list_font{font-size: 12px;}
			.list_fonts{margin-top:3px;font-size:12px;}
			.nodeqty{color: #FF4400;font-size: 16px;}
			.nodeprice:before{content: '￥';padding: 0 3px 0 5px;color: #242424;font-size:10px;}
			.nodeprice{font-size:16px;color:#242424;}
			.icon-expired-box{ position: absolute;top:0;left:0;z-index: 99;height:0;width:0;border-top:30px solid white;border-right:30px solid transparent;}
			.icon-expired{position: absolute;top:-25px;left:0;font-size:30px;color:#F0AD4E;}/*FF5053*/
			.icon-expired2{position: absolute;top:30px;right:20px;font-size:40px;color:#F0AD4E;}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav headerMain nodeHeader" id="head" style="height: 60px;">
			<a class="mui-icon mui-icon-left-nav mui-action-back  mui-pull-left" id="J_btn_back"></a>	
			<h1 class="mui-title headText" id="header"></h1>
		</header>

		<nav class="mui-bar mui-bar-tab" id="footer" style="display:;">
			<a class="mui-tab-item" id="Select" style="background:;color:#262930;margin-top:5px;">
				<!--<div style="width:25px;height:25px; margin-top:20px;border-radius:50%;background:#18B4ED;position: absolute;top:-12px;left:20px;line-height: 25px;">
				 <span id="Check1" class="mui-icon mui-icon-checkmarkempty" style="width:25px;height:25px;font-size:40px;color:#F7F7F8;line-height:25px;text-align: center;margin-left: -8px;display: none;"></span>
				<span style="margin-left:40px;">全选</span>
				</div>-->
				<!--<span class="mui-tab-label" style="margin-top:1px;">全选</span>-->
			</a>
			<a class="mui-tab-item" id="" style="background:;color:#262930;">
				<span class="mui-tab-label" style="display: none;">合计：<span style="color:red" id="amount">0</span></span>
				<!--<div class="icon-expired-box"><p class="icon-expired iconfont icon-yishixiao1"></p></div>
				<div class="icon-expired2 iconfont icon-yishixiao"></div>-->
			</a>
			<a class="mui-tab-item" id="J_btn_save" style="background:#FB6F18;color:#ffffff;">
				<span class="mui-tab-label">去结算（<span id="pickNum">0</span>）</span>
			</a>
		</nav>
		<div id="pullrefresh" class="mui-content mui-scroll-wrapper"style="">
			<div id="J_noData" class="mui-h5" style="padding:100px;height:300px;display:;text-align: center;background: ;display:none;border: transparent;background: ;">
				<span class="icon iconfont icon-wushuju" style="color:;font-size:100px;"></span>
				<p style="color:#000000;margin-top:10px;margin-bottom:0;border-bottom: transparent;padding-bottom:0;">未查询到相关的数据</p>
				<p style="font-size:10px;border-bottom: transparent;">可以尝试其他查询</p>
			</div>
			<div id="J_searching" class="mui-h5" style="padding:100px;height:300px;text-align: center;display:block;">
				<p class="mui-icon mui-icon-search" id="" style=";color:#0062cc;height:100px;line-height: 100px;font-size: 100px;"></p>
				<p style="font-size:12px;">正在搜索中......</p>
			</div>
			<div class="mui-scroll" style="border: transparent;">
				<ul id="contList" class="mui-table-view mui-table-view-striped mui-table-view-condensed" style="margin-top:20px;background:none;">
				</ul>
			</div>
			
			<div class="mui-scroll" id="content" style="background:;margin:0"></div>
			<script id="tmpl" type='text/template'>	
				
			</script>
		</div>
		<div class="mask">
			<div class="mask-tip">
				<div class="mask-title">以下产品相关政策已失效或未审核</div>
				<div class="mask-content" id="J_list_gifts"></div>
				<script id="J_temp_gifts" type="text/template">
					<ul>
						<% for(var i in data){ var item=data[i]; %>
							<li class="mui-input-row" style="border-bottom:1px dashed #C8C7CC;margin-right:10px;">
								<div class="">
									<span class="mui-icon mui-icon-locked"></span>
									【<%=item['标题']%>】<%=item['内容']%>
								</div>
								<div class="">有效期至：<%=item['日期']%></div>
							</li>
						<% } %>
					</ul>
				</script>
				<div class="mask-btn mui-row">
					<div class="mui-col-xs-4 mask-btn-item"><button id="J_btn_prevPage" class="">上一页</button></div>
					<div class="mui-col-xs-4 mask-btn-item"><button id="J_btn_read">我知道了</button></div>
					<div class="mui-col-xs-4 mask-btn-item"><button id="J_btn_nextPage" class="" >下一页</button></div>
				</div>
			</div>
		</div>
	</body>
	<script src="../../js/mui.min.js"></script>
	<script src="../../js/arttmpl.js" 		type="text/javascript" charset="utf-8"></script>
	<script src="../../js/jquery-2.1.0.js"></script>
	
	<script src="../../js/md5.js"></script>
	<script src="../../js/index.js" 		type="text/javascript" charset="utf-8"></script>
	<script src="../../js/vlindex.js" 		type="text/javascript" charset="utf-8"></script>
	<script src="../../js/immersed.js" 		type="text/javascript"></script>
	<script type="text/javascript">
		// 初始化mui
		mui.init({
			pullRefresh: {
				container: '#pullrefresh',
				down: {
					style:'circle',
					callback: pulldownRefresh
				},
				up: {
					auto:false,
					contentrefresh: '正在加载...',
					callback: pullupRefresh
				}
			}
		});
		var oRenderdata = {'data':[],'pager':{}},
		count = 1,
		totalPage = 0;
		var $$ = jQuery.noConflict();
		var mianOnlyCode = getDataCode("vdeb211");
		var detailOnlyCode = getDataCode("vdeb212");
		var detail_vInfo = [];
		var teamBillCom = "";
		var teamBillComName = "";
		var userbillNo = "";
		var loginCom = "";
		var loginComName = "";
		var flagNew = "";
		var parentPage = "";
		var search = ""; // 要查询的内容
		var startIndex = 1;
		var pageSize = 60;
		var inputData = null; // 表单里的数据
		var hadSend = false; // 用于判断是否送审
		var billnoSave = ""; // 修改时的主表bill_no 
		var detailInfo = {};
		var date = new Date();
		var bill_date = vlUtils.dateToString(date);
		//定义全局的rqs 
		var dataSourse = {}; //用来重新渲染DOM
		var saveDataSourse = []; //用来提交到212的数据
		var selectedAdataArr = [];
		var saveDeleteData = []; //用于存放删除的bill_no
		var aCheckValid = []
		var aunValidData = []; // 返回的已失效的数据
		var oChangeNum = {
			"aNo" : [],
			"aNoAndNum" : []
		}
		var mainInfos = "";
		var pickNum = 0;
		var amount = 0;
		var buy = [];
		var buyAndGift = [];
		var pager = {};
		mui.plusReady(function() {
			var self = plus.webview.currentWebview();
			teamBillCom = self.teamBillCom;
			teamBillComName = self.teamBillComName;
			userbillNo = self.userbillNo;
			loginCom = self.loginCom;
			loginComName = self.loginComName;
			parentPage = self.parentPage;
			flagNew = self.flagNew;
			fromPage = self.fromPage;
			curSys   =self.curSys
			// 查询
			VlAjax.post({
				"port" : "sendTask",
				"headers" : "json",
			},{
				bill_no   : VlTools.getBno('vdeb511'),
				bill_task : "VE_vdeb511_update_02",
				bill_user : userbillNo,
				bill_com  : teamBillCom,
				bill_date : VlDate.get((new Date()) , "_ymdhms")
			},sCUpdataDate);
			function sCUpdataDate(data){
				queryparmas = {
					name: 'vdeb511',
					bill_com: teamBillCom,
					bill_user: userbillNo,
					bill_task: "L",
					currentPage: 1,
					pageSize: pageSize,
					paramText: ""
				}
				rqsDataAjax(queryparmas, 'Find/Ddata/cartFindDetail', sCBfindData, '../login.html',true);
			
			}
			// 管理单位
			vlUtils.setStorage("agencyTeamBillCom", teamBillCom);
			// 头部显示发货单位名称
			document.getElementById("header").innerHTML = teamBillComName;
			//返回事件
			//document.getElementById("J_btn_back").addEventListener("tap", eBtnBack , false);
			mui('#J_btn_nextPage')[0].addEventListener('tap', eBtnNextPage, false);
			mui('#J_btn_prevPage')[0].addEventListener('tap', eBtnPrevPage, false);
			mui('#J_btn_read')[0].addEventListener('tap', eBtnRead, false);
	
	
			//监听back安卓   和返回观看数量相关
//			plus.key.addEventListener("backbutton", eBtnBack, false);
			// 
	
	
			$$("#contList").on("tap", ".Glist", function(e) {
				mui.toast('\n\r“赠品”不允许单独选择\n\r请选择“正品”~');
			});
			//合计金额计算
			$$("#contList").on("tap", ".Blist", function(e) {
				var e 				= this;
				var li 				= e; // 这条商品的信息dom

				var dataRow 		= JSON.parse(li.getAttribute("data-row"));			// 该条数据信息
				var pickDotState 	= jQuery(this).find(".pickDot").attr("data-show"); 	// √ 显示/隐藏状况
				var dlistQty 		= Number(jQuery(this).find(".nodeqty").html());     // 托盘数
				var tlistQty        = Number(jQuery(this).find("#math").html());        // 数量
				var dlistPrice 		= Number(jQuery(this).find(".nodeprice").html()); 	// 单价
				var MlistSerialNum 	= jQuery(this).parents("li").index(); 				// 主表的下标
				var Mdata = JSON.parse(jQuery(this).parents("li").attr("data-row"));	// 主表明细表所有信息
                
				pickNum = Number(jQuery("#pickNum").html());   //数量变量
				amount = Number(jQuery("#amount").html());     //金额变量
				document.getElementById("amount").innerHTML = amount;
				if(pickDotState == "false"){ 
					/*
					 * 目前隐藏，变为显示，即选择*/
					jQuery(this).find(".pickDot").css({"display":"block"});
					jQuery(this).find(".pickDot").attr("data-show","true");
					/*
					 * 增加去结算的数量，增加结算金额*/
//					pickNum++;
					pickNum += tlistQty;
					jQuery("#pickNum").html(pickNum);
					amount += tlistQty * dlistPrice;
					jQuery("#amount").html(amount);
					/*添加到oChangeNum*/
					pushToOchangNum(dataRow.bill_no, tlistQty);
					/*
					 * 添加到要提交的数据数组中*/
					//
				
					
					if(vlUtils.isnull(selectedAdataArr[MlistSerialNum])){
						var MD_data={
							main:Mdata.values.main,
							detail:[]
						}
						MD_data.detail.push(dataRow);
						selectedAdataArr[MlistSerialNum] = MD_data;
					}else{
						selectedAdataArr[MlistSerialNum].detail.push(dataRow);
					}
					aCheckValid.push("'"+dataRow.bill_no+"'");
					selectedAdataArr[MlistSerialNum].main.node_qty=pickNum;
					
					
					
					selectedAdataArr[MlistSerialNum].main.node_amt=amount;
					if(dataRow.bill_bflow === '正品'){
						// 
						var liIdx = buy.indexOf(dataRow.bill_no);

						var giftCN = buyAndGift[liIdx];
						var len = typeof giftCN === 'undefined' ? 0 : giftCN.length;
						for(var i = 0; i < len; i ++){

							var _giftLi 	= jQuery(this).parents("li").find(('.'+giftCN[i]));
//							var _giftQty 	= Number(_giftLi.find(".nodeqty").html());// xuyaogai
							var _giftPrice 	= Number(_giftLi.find(".nodeprice").html());
							var _idx 		= _giftLi.index(); 
							var _drow 	= _giftLi.attr("data-row");

							if(typeof _drow !== 'undefined'){
								var _drow 	= JSON.parse(_drow);
								// 重新计算赠送数量
								var _bcontext = _drow.bill_context;
								if(_bcontext !== ''){
									var _get = Number(_bcontext.split('赠')[1]);
									var _buy = Number(_bcontext.split('赠')[0].slice(1));
									var _newGiftQty = parseInt(parseInt(tlistQty / _buy) * _get);
									_giftLi.find(".nodeqty").html(_newGiftQty)
								}
								var _giftQty 	= Number(_giftLi.find(".nodeqty").html());
								_drow.node_nqty = _giftQty;
								_giftLi.attr("data-row",JSON.stringify(_drow));
								//
								_giftLi.find(".pickDot").css({"display":"block"});
								_giftLi.find(".pickDot").attr("data-show","true");
								/*
								 * 增加去结算的数量，增加结算金额*/
								pickNum += _giftQty;
								jQuery("#pickNum").html(pickNum);
								amount += _giftQty * _giftPrice;
								jQuery("#amount").html(amount);
								/*添加到oChangeNum*/
								pushToOchangNum(_drow.bill_no, _giftQty);
								
								if(vlUtils.isnull(selectedAdataArr[MlistSerialNum])){
									var MD_data={
										main:Mdata.values.main,
										detail:[]
									}
									MD_data.detail.push(MlistSerialNum);
									selectedAdataArr[MlistSerialNum] = MD_data;
								}else{
									selectedAdataArr[MlistSerialNum].detail.push(_drow);
								}
								aCheckValid.push("'"+_drow.bill_no+"'");
								selectedAdataArr[MlistSerialNum].main.node_qty=pickNum;
								console.log(JSON.stringify(pickNum))
								
								
								selectedAdataArr[MlistSerialNum].main.node_amt=amount;
							}
						}
						
					}else if(dataRow.bill_bflow === '赠品'){
						// 
					}
				}else{
					/*
				     * 目前显示，变为隐藏 ，即取消选择*/
					jQuery(this).find(".pickDot").css({"display":"none"});
					jQuery(this).find(".pickDot").attr("data-show","false");
					/*
					 * 签去结算的数量，减去当前商品的数量*/
//					pickNum--;
					pickNum -= tlistQty;
					jQuery("#pickNum").html(pickNum);
					amount -= tlistQty * dlistPrice;
					jQuery("#amount").html(amount);
					/*
					 *从提交数据的数组中删除 */
					if(selectedAdataArr[MlistSerialNum].detail.length == 1){
						selectedAdataArr[MlistSerialNum] = "";
					}else{
						for(var k = 0; k < selectedAdataArr[MlistSerialNum].detail.length; k ++){
							var dbillno = selectedAdataArr[MlistSerialNum].detail[k].bill_no
							if(dbillno == dataRow.bill_no){
								selectedAdataArr[MlistSerialNum].detail.splice(k,1);
								break;
							}
						}
						
						selectedAdataArr[MlistSerialNum].main.node_qty=pickNum;
						selectedAdataArr[MlistSerialNum].main.node_amt=amount;
					}
					if(aCheckValid.indexOf("'"+dataRow.bill_no+"'") != -1){
						aCheckValid.splice(aCheckValid.indexOf("'"+dataRow.bill_no+"'"),1);
					}
					if(dataRow.bill_bflow === '正品'){
						// 
						var liIdx = buy.indexOf(dataRow.bill_no);
						var giftCN = buyAndGift[liIdx];
						var len = typeof giftCN === 'undefined' ? 0 : giftCN.length;
						for(var i = 0; i < len; i ++){
							var _giftLi = jQuery(this).parents("li").find(('.'+giftCN[i]));
								var _giftQty = Number(_giftLi.find(".nodeqty").html());
								var _giftPrice = Number(_giftLi.find(".nodeprice").html());
								var _idx 		= _giftLi.index(); 
								var _drow 	= _giftLi.attr("data-row");
							if(typeof _drow !== 'undefined'){
								_drow 	= JSON.parse(_drow);
								
								_giftLi.find(".pickDot").css({"display":"none"});
								_giftLi.find(".pickDot").attr("data-show","false");
								
								/** 增加去结算的数量，增加结算金额*/
								pickNum -= _giftQty;
								jQuery("#pickNum").html(pickNum);
								amount -= _giftQty * _giftPrice;
								jQuery("#amount").html(amount);
								
								/**从提交数据的数组中删除 */
								if(selectedAdataArr[MlistSerialNum].detail.length == 1){
									selectedAdataArr[MlistSerialNum] = "";
								}else{
									for(var k = 0; k < selectedAdataArr[MlistSerialNum].detail.length; k ++){
										var dbillno = selectedAdataArr[MlistSerialNum].detail[k].bill_no
										if(dbillno == _drow.bill_no){
											selectedAdataArr[MlistSerialNum].detail.splice(k,1);
											break;
										}
									}
									selectedAdataArr[MlistSerialNum].main.node_qty=pickNum;
									selectedAdataArr[MlistSerialNum].main.node_amt=amount;
								}
								if(aCheckValid.indexOf("'"+_drow.bill_no+"'") != -1){
									aCheckValid.splice(aCheckValid.indexOf("'"+_drow.bill_no+"'"),1);
								}
							}
						}
						
					}else if(dataRow.bill_bflow === '赠品'){
						// 
					}
				}
			});
			
			
			// 显示数字加减框
			jQuery("#contList").on('tap', '.changeNumIcon', function(e) {
				e.stopPropagation();
				jQuery(this).parents(".infoBox").css({
					"display": "none"
				});
				jQuery(this).parents(".infoBox").siblings().css({
					"display": "block"
				});
				//
				var nowqty = jQuery(this).parent().children().children('span.nodeqty').html();
				jQuery(this).parent().parent().siblings().children().find('input').val(Number(nowqty));
				jQuery(this).parents("li").addClass("editing");
				
			});
			// 完成,隐藏数字加减框
			jQuery("#contList").on('tap', '.finishAdd', function(e) {
				e.stopPropagation();
				var e = this;
				var oldqty = Number(jQuery(this).attr("data-qty"));
				var n_qty = Number(jQuery(this).siblings().children().find('input').val());
				var docstate = jQuery(this).parents("li.Dlist").find(".pickDot").attr("data-show"); 	// √ 显示/隐藏状况
				var MlistSerialNum 	= jQuery(this).parents("li.Mlist").index(); 				// 主表的下标
				var DlistSerialNum 	= jQuery(this).parents("li.Dlist").index(); 
				
				// 主表的下标
				if(n_qty >= 1){
				    rowdata = JSON.parse(jQuery(this).parents("li.Dlist").attr("data-row"));
					var price = Number(jQuery(this).parents("li.Dlist").find('.nodeprice').html());
					// 行数量要变
					jQuery(this).parent().siblings().children().children().find(".nodeqty").html(n_qty);
					 
					
					jQuery(this).attr("data-qty",n_qty);
					math=jQuery(this).attr("data-qty")
					rowdata.node_nqty = n_qty;
					rowdata.node_amt = math*rowdata.node_nprice*price;
					rowdata.node_qty=math*rowdata.node_nprice
					rowdata.node_nrate=math*rowdata.node_namt
					jQuery(this).parents("li.Dlist").attr("data-row",JSON.stringify(rowdata));
//					console.log(JSON.stringify(rowdata))
					/*添加到oChangeNum*/
					pushToOchangNum(rowdata.bill_no, rowdata.node_qty);
    
					jQuery(this).parent().next().children().find("#math").html(math*rowdata.node_nprice)
					jQuery(this).parent().next().children().find("#kg").html(math*rowdata.node_namt)
					// 如果选中状态，结算数量要变，合计金额要变,
					if(docstate=="true"){
						pickNum = Number(jQuery("#pickNum").html());
						amount = Number(jQuery("#amount").html());
						pickNum = pickNum - oldqty + n_qty;
						amount  = amount - oldqty*price + n_qty*price;
						jQuery("#pickNum").html(pickNum);
						jQuery("#amount").html(amount);
						//
						selectedAdataArr[MlistSerialNum].main.node_qty = pickNum;
						selectedAdataArr[MlistSerialNum].main.node_amt = amount;
						//
						var detaillis = selectedAdataArr[MlistSerialNum].detail;
						var lens = selectedAdataArr[MlistSerialNum].detail.length;
						for(var i = 0; i < lens; i ++){
							if(detaillis[i].bill_no == rowdata.bill_no){
								detaillis[i] = rowdata;
							}
						}
					}
					// 
					jQuery(this).parents(".changeNumBox").css({
						"display": "none"
					});
					jQuery(this).parents(".changeNumBox").siblings().css({
						"display": "block"
					});
					jQuery(this).parents("li").removeClass("editing");
					//
					if(rowdata.bill_bflow === '正品'){
						// 
						var liIdx = buy.indexOf(rowdata.bill_no);
						var giftCN = buyAndGift[liIdx];
						var len = typeof giftCN === 'undefined' ? 0 : giftCN.length;
						for(var i = 0; i < len; i ++){
							var _giftLi 	= jQuery(this).parents("li").find(('.'+giftCN[i]));
								var _oldGiftQty 	= Number(_giftLi.find(".nodeqty").html());// xuyaogai
								var _giftPrice 	= Number(_giftLi.find(".nodeprice").html());
								var _idx 		= _giftLi.index(); 
								var _drow 	= _giftLi.attr("data-row");
							if(typeof _drow !== 'undefined'){
								_drow 	= JSON.parse(_drow);
								// 重新计算赠送数量
								var _bcontext = _drow.bill_context;
								if(_bcontext !== ''){
									var _get = Number(_bcontext.split('赠')[1]);
									var _buy = Number(_bcontext.split('赠')[0].slice(1));
									var _newGiftQty = parseInt(parseInt(n_qty / _buy) * _get);
									_giftLi.find(".nodeqty").html(_newGiftQty)
								}
								var _giftQty 	= Number(_giftLi.find(".nodeqty").html());
	//							console.log(JSON.stringify(_drow))
								_drow.node_nqty = _giftQty;
								_drow.node_amt = _giftQty*_giftPrice;
								_giftLi.attr("data-qty",_giftQty);
								_giftLi.attr("data-row",JSON.stringify(_drow));
								/*添加到oChangeNum*/
								pushToOchangNum(_drow.bill_no, _giftQty);
	//							console.log(JSON.stringify(_drow))
								if(docstate=="true"){
									/*
									 * 增加去结算的数量，增加结算金额*/
									pickNum = pickNum - _oldGiftQty + _giftQty;
									jQuery("#pickNum").html(pickNum);
									amount = amount + ( _giftQty - _oldGiftQty )* _giftPrice;
									jQuery("#amount").html(amount);
	//								if(vlUtils.isnull(selectedAdataArr[MlistSerialNum])){
	//									var MD_data={
	//										main:Mdata.values.main,
	//										detail:[]
	//									}
	//									MD_data.detail.push(MlistSerialNum);
	//									selectedAdataArr[MlistSerialNum] = MD_data;
	//								}else{
	//									selectedAdataArr[MlistSerialNum].detail.push(_drow);
	//								}
									selectedAdataArr[MlistSerialNum].main.node_qty=pickNum;
									selectedAdataArr[MlistSerialNum].main.node_amt=amount;
									var detaillis = selectedAdataArr[MlistSerialNum].detail;
									var lens = selectedAdataArr[MlistSerialNum].detail.length;
									for(var i = 0; i < lens; i ++){
										if(detaillis[i].bill_no == _drow.bill_no){
											detaillis[i] = _drow;
										}
									}
								}
							}
						}
						
					}else if(rowdata.bill_bflow === '赠品'){
						// 
					}
				}else{
					mui.toast("最少是一件哦~");
				}
			});
				
			
			// 减
			jQuery("#contList").on('tap', '.minus', function(e) {
				e.stopPropagation();
				var num = jQuery(this).parent().find('input').val();
				var docstate = jQuery(this).parents("li").find(".pickDot").attr("data-show"); 	// √ 显示/隐藏状况
				if(num >= 2) {
					num--;
					jQuery(this).parent().find('input').val(num);
				}else{
					mui.toast("不能再减了哦~")
				}
			});
			// 加
			jQuery("#contList").on('tap', '.plus', function(e) {
				e.stopPropagation();
				var num = Number(jQuery(this).parent().find('input').val());
				var docstate = jQuery(this).parents("li").find(".pickDot").attr("data-show"); 	// √ 显示/隐藏状况
				num++;
				jQuery(this).parent().find('input').val(num);
				checkNum(jQuery(this).parent().find('input'),jQuery(this).parent().find('input').val());
			});
			//
			jQuery("#contList").on('tap', 'input', function(e) {e.stopPropagation();});
			//
			
			//Select全选
			$$("#Select").on("tap", function(e) {
				$$("#Check1").toggle();
				if($$("#Check1").is(':hidden')) {
//					document.getElementById("Check").style.display = "none";
				} else {
//					document.getElementById("Check").style.display = "block";
				}
			})
			// 删除 
			jQuery("#contList").on('tap', '.mui-btn-red', function(e) {
				e.stopPropagation();
				var e = this;
				var li = e.parentNode.parentNode;
				var rowObj = JSON.parse(li.getAttribute("data-row"));
				var DlSerialNum = jQuery(li).index();
				var MlSerialNum 	= jQuery(li).parent().parent().index(); 	
				var MdataRow = JSON.parse(jQuery("li.Mlist").attr("data-row"));
				var dotstate = jQuery(li).find(".pickDot").attr("data-show");
				var type = rowObj.bill_bflow;
				mui.confirm('确认删除该商品？', '删除确认', ["确认","取消"], function(e) {
					if (e.index == 0) {
						li.parentNode.removeChild(li);
						var rqsData = {
							bill_no: rowObj.bill_no,
							bill_task: "d_delete",
							fbill_no: MdataRow.values.main.bill_no,
							bill_user: userbillNo, // 登陆人
							bill_com: teamBillCom, //登录人单位  
							node_nqty: rowObj.node_nqty,
							node_price: rowObj.node_price
						}
						deleteData(rqsData);
						if(dotstate == "true"){
							// 减结算总数量,减金额
							var price = Number(jQuery(li).find(".nodeprice").html());
							var qty = Number(jQuery(li).find(".nodeqty").html());
							pickNum = Number(jQuery("#pickNum").html());
							amount = Number(jQuery("#amount").html());
							pickNum -= qty;
							amount -= qty*price ;
							jQuery("#pickNum").html(pickNum);
							jQuery("#amount").html(amount);
							// 从数组中删掉，同时修改主表数量和金额
							selectedAdataArr[MlSerialNum].main.node_qty = pickNum;
							selectedAdataArr[MlSerialNum].main.node_amt = amount;
							//
							var detaillis = selectedAdataArr[MlSerialNum].detail;
							var lens = selectedAdataArr[MlSerialNum].detail.length;
							for(var i = 0; i < lens; i ++){
								if(detaillis[i].bill_no == rowObj.bill_no){
									detaillis.splice(i,1);
									break;
								}
							}
							selectedAdataArr[MlSerialNum].detail = detaillis
						}
						if(rowObj.bill_bflow === '正品'){
							// 
							var liIdx = buy.indexOf(rowObj.bill_no);
							var giftCN = buyAndGift[liIdx];
							var len = typeof giftCN === 'undefined' ? 0 : giftCN.length;
							for(var i = 0; i < len; i ++){
								var _giftLi 	= jQuery('.Glist').parent().find(('.'+giftCN[i]));
									var _giftPrice 	= Number(_giftLi.find(".nodeprice").html());
									var _giftQty 	= Number(_giftLi.find(".nodeqty").html());
									var _idx 		= _giftLi.index(); 
									var _drow 	= _giftLi.attr("data-row");
								if(typeof _drow !== 'undefined'){
									_drow 	= JSON.parse(_drow);
									_giftLi.remove();
									var _p = {
										bill_no: _drow.bill_no,
										bill_task: "d_delete",
										fbill_no: MdataRow.values.main.bill_no,
										bill_user: userbillNo, // 登陆人
										bill_com: teamBillCom, //登录人单位  
										node_nqty: _drow.node_nqty,
										node_price: _drow.node_price
									}
									deleteData(_p);
									if(dotstate=="true"){
										/*
										 * 增加去结算的数量，增加结算金额*/
										pickNum = pickNum - _giftQty;
										jQuery("#pickNum").html(pickNum);
										amount = amount - _giftQty * _giftPrice;
										jQuery("#amount").html(amount);
										selectedAdataArr[MlSerialNum].main.node_qty=pickNum;
										selectedAdataArr[MlSerialNum].main.node_amt=amount;
										var detaillis = selectedAdataArr[MlSerialNum].detail;
										var lens = selectedAdataArr[MlSerialNum].detail.length;
										for(var i = 0; i < lens; i ++){
											if(detaillis[i].bill_no == _drow.bill_no){
												detaillis.splice(i,1);
												break;
											}
										}
										selectedAdataArr[MlSerialNum].detail = detaillis
									}
								}
								
							}
							
						}else if(rowObj.bill_bflow === '赠品'){}
					} else {
						setTimeout(function() {
							mui.swipeoutClose(li);
						}, 0);
					}
				});
			});
			// 保存
			document.getElementById("J_btn_save").addEventListener("tap", eBtnSave, false);

			//删除
			function deleteData(rqsData) {
				VlAjax.post({
					"port" : "carDelete",
					"headers" : "json",
				},rqsData,sCBDelete);
			}
			
			function sCBDelete(data) {
				mui.toast(data.message);
			}
		}); // PlusReady 结束
		function pushToArr(giftNO, buyNO) {
			// 默认先返回正品后返回赠品
			var _temp = [];
//			var _temp = {};
//			_temp[buyNO]= [];
			var _idx = buy.indexOf(buyNO); 
			if(_idx === -1){
				buy.push(buyNO);
				_idx = buy.length -1 ;
				buyAndGift[_idx] = JSON.parse(JSON.stringify(_temp));
				buyAndGift[_idx].push(giftNO);
//				buyAndGift[_idx][buyNO].push(giftNO);
			}else{
				if(typeof buyAndGift[_idx] === 'undefined'){
					buyAndGift[_idx] = JSON.parse(JSON.stringify(_temp));
				}
			}
			buyAndGift[_idx].push(giftNO);
		}
		function pullupRefresh() {
				setTimeout(function() {
					count++
//						mui('#pullrefresh').pullRefresh().endPullupToRefresh((++count > totalPage)); //参数为true代表没有更多数据了。
						if((count > totalPage)){
						 	mui.toast('没有更多数据了～');
						}else{
						 	ajaxParam = getParam(count);
							ajaxRequest(ajaxParam.opt,ajaxParam.param,ajaxParam.sCB,ajaxParam.eCB);
						 }
						mui('#pullrefresh').pullRefresh().endPullupToRefresh();
				}, 1500);
			}
			
			// 下拉刷新
		function pulldownRefresh() {  
			mui.toast("加载中...");
			document.getElementById("contList").innerHTML = "";
			document.getElementById("J_noData").style.display = "none";
			//
			queryparmas.currentPage = 1;
			rqsDataAjax(queryparmas, 'Find/Ddata/cartFindDetail', sCBfindData, '../login.html',true);
			mui('#pullrefresh').pullRefresh().endPulldownToRefresh(); //下拉完成后可以再次执行下拉刷新
		}
		// 上拉加载
		function pullupRefresh() {
			if(queryparmas.currentPage < pager.totalPage) {
				queryparmas.currentPage = queryparmas.currentPage + 1;
			} else {
				plus.nativeUI.toast("~没有更多啦~", {
					'verticalAlign': "middle"
				});
				mui('#pullrefresh').pullRefresh().endPullupToRefresh();
				return;
			}
			rqsDataAjax(queryparmas, 'Find/Ddata/cartFindDetail', sCBfindData, '../login.html',false);
			mui('#pullrefresh').pullRefresh().endPullupToRefresh();
		}
		
		function sCBfindData(data,type){
			var _now = new Date();
			if(data.code == 0) {
				var text = " ";
				var datas = data.data;
//				console.log(JSON.stringify(datas))
				pager = data.page[0];
				var dataArr = datas;
				dataSourse = dataArr;
				if(dataArr.length != 0) {
//						var text = "";
					var contList = document.getElementById("contList");
					for(var i = 0; i < dataArr.length; i++) {
						if(type&&i==0){
							contList.innerHTML = "";
						}
						var li = document.createElement("li");
						li.setAttribute("data-row",JSON.stringify(dataArr[i]));
						li.setAttribute("class", "mui-table-view-cell Mlist");
//						console.log(JSON.stringify(dataArr[i]))
						var text = "";
						text += '<div class="topStore" style="height:30px;background:white;border-bottom: 1px solid #E0E0E0;margin-bottom:2px;">';
						text += '<span class="mui-icon mui-icon-home"></span>';
						text += '<span style="margin-left:10px">' + dataArr[i].values.main.bill_name + '</span>';
						text += '<span style="float:right;"></span>';
						text += '</div>';
						text += '<ul class="goodsD mui-table-view mui-table-view-striped mui-table-view-condensed" style="padding:0;margin: 0;overflow: hidden;">';
						for(var k = 0; k < dataArr[i].values.detail.length; k++) {
							var abAndG = [];
							if(dataArr[i].values.detail[k].bill_bflow == "正品"){
//									console.log("正"+i+"---"+dataArr[i].values.detail[k].bill_no)
								buy.push(dataArr[i].values.detail[k].bill_no);
								buyAndGift[buy.length-1] = JSON.parse(JSON.stringify(abAndG));
//									console.log("正"+i+"---"+JSON.stringify(buy));
								text += '<li class="mui-table-view-cell Dlist Blist" data-row=\'' + JSON.stringify(dataArr[i].values.detail[k]) + '\'>';
							}else{
//									pushToArr(dataArr[i].values.detail[k].bill_no,dataArr[i].values.detail[k].bill_title);
//									console.log("赠"+i+"---"+dataArr[i].values.detail[k].bill_no)
								buyAndGift[buy.length-1].push(dataArr[i].values.detail[k].bill_no);
//									console.log("赠"+i+"---"+JSON.stringify(buyAndGift))
								text += '<li class="mui-table-view-cell Dlist Glist '+dataArr[i].values.detail[k].bill_no+'" data-row=\'' + JSON.stringify(dataArr[i].values.detail[k]) + '\'>';
//									text += dataArr[i].values.detail[k].bill_no;
							}
							
							text += '<div class="mui-slider-right mui-disabled"><a class="mui-btn mui-btn-red">删除</a></div>';
							text += '<div class="mui-slider-cell mui-slider-handle" style="">';
							text += '<div class="mui-row" style="">';
							text += '<div class="mui-col-xs-1 pickDotBox">';
							text += '<div style="width:25px;height:25px; margin-top:20px;border-radius:50%;border:1px solid #18B4ED;">';
							text += '<span class="mui-icon mui-icon-checkmarkempty pickDot" data-show="false" style="font-size:40px;color:#18B4ED;line-height:25px;text-align: center;margin-left: -8px;display:none;"></span>';
							text += '</div>';
							text += '</div>';
							text += '<div class="mui-col-xs-3 mui-row" style="padding:5px;position:relative;">';
							text += '<img class="vdvc311 mui-col-xs-12" src="../../images/icon/default.png" id="' + dataArr[i].values.detail[k].bill_no + '" style="width:60px;height:60px;border-radius: 5px;" />';
							text += '</div>';
							text += '<div class="mui-col-xs-8 ">';
							text += '<div class="mui-row changeNumBox" id="" style="display:none;overflow:hidden;">';
							text += '<div class="mui-col-xs-9" style="background:;height:50px;position: relative;">';
							text += '<div class="mui-row" style="position: absolute;top:20px;left:5%;border:1px solid #E0E0E0;border-radius: 5px;text-align:center;">';
							text += '<div class="mui-col-xs-3 minus" style="line-height:25px;border-right:1px solid #E0E0E0;">-</div>';
							text += '<div class="mui-col-xs-6" style="padding: 0;margin: 0;">';
							text += '<input  type="number" min="1" oninput=checkNum(this,this.value) style=" float:left;border:none;height:25px;margin:0;">';
							text += '</div>';
							text += '<div class="mui-col-xs-3 plus" style="line-height:25px;border-left:1px solid #E0E0E0;">+</div>';
							text += '</div>';
							text += '</div>';
							text += '<div class="mui-col-xs-3 mui-row finishAdd" data-qty="'+dataArr[i].values.detail[k].node_nqty+'" style="overflow: hidden;">';
							text += '<p class="list_fonts mui-col-xs-12" style="background:#f0ad4e;height:70px;line-height:70px;text-align:center;color:#fff;margin:auto 5px;">完成</p>';
							text += '</div>';
							text += '</div>';
							text += '<div class="mui-row infoBox" style="display:block;overflow:hidden;min-height:70px;">';
							text += '<div class="mui-col-xs-9 mui-row" style="background:;">';
							var _etime = new Date(dataArr[i].values.detail[k].bill_edate);
							if ( _now > _etime){
								text += '<div class="icon-expired2 iconfont icon-yishixiao"></div>';
							}
							text += '<h5 class="list_h5 mui-col-xs-12 billname" style="color:#242424;">' + dataArr[i].values.detail[k].bill_name+'(' +dataArr[i].values.detail[k].bill_bflow+ ')</h5>';
							text += '<p class="list_font mui-col-xs-6 bilid">' + dataArr[i].values.detail[k].bill_id + '</p>';
							text += '<p class="list_font mui-col-xs-6 billspec">'+ dataArr[i].values.detail[k].bill_spec +'</p>';
							text += '<p class="list_font mui-col-xs-6 " style="color:#242424;">数量:<span  id="math"  >'+ dataArr[i].values.detail[k].node_qty+'</span>件</p>';
							text += '<p class="list_font mui-col-xs-6 ">重量:<span  id="kg" >'+ dataArr[i].values.detail[k].node_nrate+'</span>KG</p>';
							text += '</div>';
							text += '<div class="mui-col-xs-3 mui-row list_three" style="text-align:right;padding-right:5px">';
							if(dataArr[i].values.detail[k].bill_bflow == "正品"){
								text += '<p class="list_fonts mui-col-xs-12 changeNumIcon"><span class="mui-icon mui-icon-compose"></span></p>';
							}
							text += '<p class="list_fonts mui-col-xs-12">托盘数:<span class="nodeqty" >' + dataArr[i].values.detail[k].node_nqty + '</span></p>';
							text += '<p class="list_fonts mui-col-xs-12" style="display:none;"><span class="nodeprice">' + dataArr[i].values.detail[k].node_price + '</span></p>';
							text += '</div>';
							text += '</div>';
							text += '</div>';
							text += '</div>';
							text += '</div>';
							text += '</li>';
						}
//							buyAndGift.push(JSON.parse(JSON.stringify(abAndG)));
						text += '</ul>';
//							text += '</li>';
//							document.getElementById("J_searching").style.display = "none";
//							contList.innerHTML = text;
						if(type&&i==0){
							document.getElementById("J_searching").style.display = "none";
						}
						li.innerHTML = text;
						contList.appendChild(li);
					}
					for(var a = 0; a < dataArr.length; a++) {
						for(var b = 0; b < dataArr[a].values.detail.length; b++) {
							vlUtils.downloadicon(dataArr[a].values.detail[b].bill_nspec, dataArr[a].values.detail[b].bill_no );
						}
					}
				} else {
					document.getElementById("J_searching").style.display = "none";
					document.getElementById("J_noData").style.display = "block";
					mui.toast("未查询到数据");
				}
			}
		plus.nativeUI.closeWaiting();
	}
		function checkNum(self,val) {
			var v = val.replace(/^-/,'').replace(/\.[0-9]*$/,''); // 去小数点
			if(v > 99999){
				mui.toast('录入数量最大为99999');
				v = Number(v) === 100000 ? 99999 : parseInt(v / 10);
			}
			typeof self.value !== 'undefined' ? self.value = v : self.val(v);
		}
		
		
		/* 返回查看数量  在进入购物车数量有变  目前只更改了数量  托盘数和重量没变 所以封掉
		function eBtnBack() {
			var oldBack = mui.back;
			var sNoAndNum = oChangeNum.aNoAndNum.join(',');
			if(oChangeNum.aNo.length == 0){
				mui.back();
			}else{
				var _p = {
					bill_no : VlTools.getBno('vdeb511'),
					cc_user : sNoAndNum,
					bill_task : "VE_vdeb511_update_01",
					bill_user : userbillNo,
					bill_com  : teamBillCom,
					bill_date : VlDate.get((new Date()) , "_ymdhms")
				};
				console.log(JSON.stringify(_p))
				VlAjax.post({
					"port" : "sendTask",
					"headers" : "json",
				},_p,sCBchange);
			}
		}
		function sCBchange(data) {
			mui.back();
		}
		
		*/
		function stopSave(txt){
			plus.nativeUI.toast(txt, {'verticalAlign': "top"});
			plus.nativeUI.closeWaiting();
		}
		function eBtnSave() {
			plus.nativeUI.showWaiting();//这里是开始显示原生等待框
			if(pickNum <=0){
				stopSave("请先选择要结算的商品~")
				return;
			}
			if(jQuery(".editing").length !== 0 ){
				stopSave("页面上有正在修改数量的地方，\r\n请先点击“完成”按钮后再提交");
				return;
			}
			for(var i = selectedAdataArr.length-1 ; i >= 0 ; i -- ){
				if(!!!selectedAdataArr[i]){
					selectedAdataArr.splice(i,1);
				}
			}
			var sCheckValid = aCheckValid.join(',');
	
			var _p = {
				bill_no  : sCheckValid,
				bill_task : "VR_vdeb511_query_01",
				bill_user : userbillNo,
				bill_com  : teamBillCom,
				bill_date : VlDate.get((new Date()) , "_ymdhms"),			
			};
//			console.log(JSON.stringify(_p))
//			var _p = {"name":"msvr","bill_task":"VR_find_item001","bill_com":"vdvc10100_20170801_0101C001","bill_user":"vdvc00100_20170707_0707A007","bill_title":"","currentPage":1,"pageSize":30,"paramText":""}
			// TODO
//			console.log('jiesuan:'+JSON.stringify(_p));

			VlAjax.post({
				"port" : "active",
				"headers" : "json",
			},_p,sCBcheck);
		}
		function sCBcheck(data){
			plus.nativeUI.closeWaiting();
//			console.log(JSON.stringify(data))
			if(data.data.length === 0 ){
				mui.openWindow({
					url: "vdeb212sc_edit.html",
					id: "vdeb212sc_edit.html",
					extras: {
						teamBillCom		: teamBillCom,
						userbillNo		: userbillNo,
						selectedAdataArr: selectedAdataArr,
						amount			: amount,
						pickNum			: pickNum,
						teamBillComName	: teamBillComName,
						fromPage		: fromPage,
						curSys          : curSys,
					},
					createNew: true
				})
			}else{
				aunValidData = data.data;
				getUnValidData(1);
				mui('.mask-title')[0].setAttribute('data-page',1);
				mui('.mask')[0].style.display = 'block';
			}
		}
		function eBtnRead(e){
			mui('.mask')[0].style.display = 'none';
		}
		function eBtnPrevPage(e){
			var curPage = mui('.mask-title')[0].getAttribute('data-page');
			curPage--;
			mui('.mask-title')[0].setAttribute('data-page',curPage);
			getUnValidData(curPage);
		}
		function eBtnNextPage(e){
			var curPage = mui('.mask-title')[0].getAttribute('data-page');
			curPage++;
			mui('.mask-title')[0].setAttribute('data-page',curPage);
		}
		function getUnValidData(pageNo){
			var size = 6;
			var maxIdx = aunValidData.length -1 ;
			var maxPage = Math.ceil(aunValidData.length / size) ;
			var startIdx = ( pageNo - 1 ) * size;
			var endIdx = pageNo * size - 1;
			endIdx = endIdx > maxIdx ? maxIdx : endIdx;
			var _json = [];
			for(var i = startIdx; i <= endIdx; i++){
				var rowdataJson = {};
				for(var k in aunValidData[i]) {
					rowdataJson[k.slice(0, 2)] = aunValidData[i][k];
				}
				_json.push(rowdataJson);
			}
			mui('#J_btn_prevPage')[0].style.display =  (pageNo == 1) ? 'none' : 'block';
			mui('#J_btn_nextPage')[0].style.display =  (pageNo == maxPage) ? 'none' : 'block';
//			return _json;
			mui('#J_list_gifts')[0].innerHTML = template('J_temp_gifts', {"data":_json});
		}
		// 修改数量
		function pushToOchangNum(bno, num){
			var idx = oChangeNum.aNo.indexOf(bno);
			var str = bno + ":" + num;
			
			if(idx > -1 ){
				oChangeNum.aNoAndNum[idx] = str;
			}else{
				oChangeNum.aNo.push(bno);
				oChangeNum.aNoAndNum.push(str);
			}
		}
	</script>

</html>