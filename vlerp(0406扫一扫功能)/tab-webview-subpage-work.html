<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>work</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
		<link rel="stylesheet" type="text/css" href="css/common/mui.css">
		<link rel="stylesheet" type="text/css" href="css/common/app.css" />
		<link rel="stylesheet" type="text/css" href="css/fonts/iconfont.css" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<style type="text/css">
			.mui-table-view{
				border:none !important;
			}
			.mui-card{
				box-shadow: none;
			}
			body{
				background:#f6f6f6;
			}
			.new-carousel { height: 30px; line-height: 30px;color:;font-size:12px;padding-left:5px; margin: 0 auto; position: relative; overflow: hidden; }
        	.new-carousel-div { position: absolute; top: 0px; }
        	.new-carousel-item { 
        		font-size:12px;
        		display: block;
        		overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;}
			.mui-table-view:after,.mui-table-view-cell:after,.mui-card-header:after{
				height: 0;
			}
			.dModule{
				padding:5px !important;
				margin:0;
			}
			.banner-img {height: 125px;}
			.hide{display: none;}
		</style>
	</head>

	<body>
		<div class="mui-content">
				<div id="tabbar" class="mui-control-content mui-active">
					<div class="mui-slider">
						<div class="mui-slider-group mui-slider-loop" id="offical" >
							<div class="mui-slider-item mui-slider-item-duplicate">
								<a><img class="banner-img" src="images/banner/banner-vl/300x125-05.png" /></a>
							</div>
							<div class="mui-slider-item">
								<a><img class="banner-img" src="images/banner/banner-vl/420x175-01.png" /></a>
							</div>
							<div class="mui-slider-item">
								<a><img class="banner-img" src="images/banner/banner-vl/300x125-06.png" /></a>
							</div>
							<div class="mui-slider-item">
								<a><img class="banner-img" src="images/banner/banner-vl/300x125-05.png" /></a>
							</div>
							<div class="mui-slider-item mui-slider-item-duplicate">
								<a><img class="banner-img" src="images/banner/banner-vl/420x175-01.png" /></a>
							</div>
						</div>
					</div>
					<div id="news" class="mui-row hide" style="width:100%;padding:auto 10px;height:30px;line-height: 30px;background:#f0f0f0;display:block;">
						<span id="" class="mui-col-xs-3"  style="color:#000000;font-weight:;padding-left:5px;">信息快报</span>
						<span id="" class="mui-col-xs-7 mui-row"  style="">
							<span class="new-carousel mui-col-xs-12" style="">
						        <span class="new-carousel-div">
						            <span class="new-carousel-item"><span style="color:red;">HOT </span>扫码可以取得额外福利了</span>
						            <span class="new-carousel-item"><span style="color:red;">推荐 </span>燕京帝道：拉响燕京啤酒品牌升级“加速度”</span>
						        </span>
							</span>
						</span>
						<span id="openUrl" class="mui-col-xs-2" data-href='https://yanjingbeer.jd.com/' style="text-align:right;font-size:12px;padding-right:5px;color:#18B4ED;">| 更多</span>
					</div>
				</div>
				
				<div id="J_menus_box"></div>
				<div class="" id="progressbarBox" style="display: none;padding: 10px;">
					<div class="" id="progressbarNum" style="text-align:right;padding-right:10px;"></div>
					<div class="" id="progressbar" style="margin:15px;display:;">
						<div id="demo1" class="mui-progressbar" style="height: 10px;">
							<span></span>
						</div>
					</div>
					<div  style="padding-right:10px;margin-top:10px;text-align:center;">
						<div>正在下载中,请耐心等待</div>
						<div>下载完成后会自动打开安装页面</div>
					</div>
				</div>
				<script  id="J_menus_tmpl" type="text/template">
					<ul id="J_menus_box" class="mui-table-view mui-table-view-striped mui-table-view-condensed" style="background: none;">
						<% for(var i in data){ var item=data[i]; %>
							<li class="mui-table-view-cell" style="padding:0;margin:0;padding-top:10px;">
								<div style="background:#fff;margin:auto 10px;border-radius:10px;padding-bottom:2px;">
									<div class="data-row hide"><%=item.rowdata%></div>
									<p class="mui-row" style="height:25px;line-height:25px;padding:0;margin:0;position: relative;overflow: hidden;border-bottom: 1px solid #f0f0f0;">
										<span class="mui-col-xs-12 mui-row" style="text-align:center;font-size: 14px;color:;">
											<span class="icon iconfont icon-beer mui-col-xs-4" style="text-align: right;font-size:13px;"> </span> 
											<span class="mtitle mui-col-xs-4" style="text-align:center;"><%=item.liTitle%></span> 
											<span class="icon iconfont icon-pijiu1 mui-col-xs-4" style="text-align: left;"> </span>  
										</span>
										<span class="mui-col-xs-4 ckpsFindMore" style="text-align: right;font-size: 12px;position: absolute;top:0px;right:10px;display:none;">
											<span class="" style="color:darkgray;padding-right:5px;">查看更多</span>
											<span class="mui-icon mui-icon-forward" style="color:#fff;margin-right:10px;font-size: 14px;background:#2187E7;border-radius: 50%;"></span>
										</span>
									</p>
									<div class="mui-card" style="margin-top:0px;">
										<div class="mui-card-header" style="display: none;"></div>
										<div class="mui-card-content">
											<div class="mui-card-content-inner" style="margin:0;padding:0;">
												<ul class="mui-table-view mui-grid-view mui-grid-9 contBodyUl" style="background:#FFFFFF;">
													<% for(var j in item.liDetail){ var dmenu=item.liDetail[j]; %>
														<li class="mui-table-view-cell mui-media mui-col-xs-3 mui-col-sm-3 dModule" style="background:;">
															<a>
																<div class="data-drow hide"><%=dmenu.rowdata%></div>
																<span class="mui-badge mui-badge-danger" style="position:absolute;right:5%;top:15%;display:none;">1</span>
																<span style="width:45px;height:45px;">
																	<img src="<%=dmenu.liImgSrc%>" onerror="this.src='images/defult/vdvc206.png'" style="width:45px;height:45px;" />
																</span>
																<div class="mui-media-body" style="margin-top:1px"><%=dmenu.liTitle%></div>
															</a>
														</li>
													<% } %>
												</ul>
											</div>
										</div>
										<div class="mui-card-footer" style="display: none;">页脚</div>
									</div>
								</div>
							</li>
						<% } %>
					</ul>
				</script>
				
		</div>
	</body>
	<script type="text/javascript" src="js/mui.min.js"></script>
	<script type="text/javascript" src="js/common.js"></script>
	<script type="text/javascript" src="js/jquery-2.1.0.js"></script>
	<script type="text/javascript" src="js/writeJsonFile.js"></script>
	<script src="js/md5.js"></script>
	<script type="text/javascript" src="js/arttmpl.js"></script>
	<script type="text/javascript" src="js/vlindex.js"></script>
	<script type="text/javascript" src="js/vljs/vlMenus.js"></script>
	<script type="text/javascript">
		mui.init();
		var aDept=[],
			deptNo = "ROOT",
			deptName = "",
			nDmenusNum = 0,
			oldBack = mui.back,
			mobile = null,
			oMobileType = {
				"Apple" : "none",
				"iOS"	: "none",
				"null" : "none",
				"Android" : "block",
			},
			teamBillCom,teamBillComName,
			userbillNo,userName,userRole,userinfo,
			loginCom,loginComName,
			privileges,billcoppo,
			moduleArr = [],
			mMenuBno = [],
			aImg = [];
		mui.plusReady(function() {
			plus.screen.lockOrientation("portrait-primary");  // 禁止横屏显示
			mobile =plus.os.name;	//Apple/null/Android 获取当前设备信息
			document.getElementById("news").style.display = oMobileType[mobile] || "none";
			setBanner();	// banner轮播
			getNewestInfo(); // 获取当前用户、单位、身份等信息
			userinfo = JSON.parse(VlStore.pGet('user'));
			deptName = teamBillComName;
			mui.back = newBack;
			var vMenus = new Vmenus(mui, {
				menusBox : "J_menus_box",
				menusTmpl : "J_menus_tmpl",
				pageNO : "01", // 放窜查询用:"01"
				baseData : {
					teamBillCom     : VlStore.pGet("newTeamBillCom"),
					teamBillComName : VlStore.pGet("newTeamBillComName"),
					userbillNo      : VlStore.pGet("userbillNo"),
					userName        : VlStore.pGet("userName"),
					loginCom        : VlStore.pGet("newLoginCom"),
					loginComName    : VlStore.pGet("newLoginComName"),
					privileges      : VlStore.pGet("newPrivileges"),
					userRole        : VlStore.pGet("newUserRole"),
					billcoppo       : VlStore.pGet("newBillcoppo"),
					curSys          : userinfo.com_linkvd_userCom,
					fbill_no		: "ROOT",
				},			
			}, VlAjax)
			bindEvent();
	}); // plusready
	function newBack() {
		plus.runtime.quit();
		return;
	}
	function bindEvent(){
		window.addEventListener('reload', function(event) { ecReload(event);});
		window.addEventListener('changeCom', function(event) { ecChangeCom(event);});		
		document.getElementById("openUrl").addEventListener("tap",eOpenUrl);
		
	}
	function eOpenUrl(){
		var linkUrl = this.getAttribute("data-href");
		mui.toast("正在准备打开页面~");
		mui.openWindow({
			url:"layout/loadUrl.html",
			id:"loadUrl.html",
			extras:{
				urls:linkUrl,
				fromPage:"work"
			}
		})
	}
	function setBanner(){
		var gallery = mui('.mui-slider');
		gallery.slider({
			interval: 5000 //自动轮播周期，若为0则不自动播放，默认为0；
		});
		//
		var carouselheight = jQuery(".new-carousel-item:last").height();
        var carousellens = jQuery(".new-carousel-item").length;
        var idxnum = 1;
        var t = 0;
        setInterval(function () {
            if (idxnum >= carousellens) {
                idxnum = 0;
                t = 0;
            }                
            jQuery(".new-carousel-div").animate({ top: (t - idxnum) * carouselheight }, 1000);                
            idxnum++;
        }, 5000);
	}
	function ecChangeCom(event) {
		billcoppo = event.detail.nowcoppo;
		userRole = event.detail.nowUserRole;
		document.getElementById("J_menus_box").innerHTML = "";
		plus.nativeUI.showWaiting("正在刷新菜单页...\n 请耐心等待"); 
		plus.webview.currentWebview().reload();
	}
	function ecReload(event){
		var reload = event.detail.reload;
		plus.webview.currentWebview().reload();
	}
	function getNewestInfo() {
		teamBillCom 	= VlStore.pGet("newTeamBillCom");
		teamBillComName = VlStore.pGet("newTeamBillComName");
		userbillNo 		= VlStore.pGet("userbillNo");
		userName 		= VlStore.pGet("userName");
		loginCom 		= VlStore.pGet("newLoginCom");
		loginComName	= VlStore.pGet("newLoginComName");
		privileges 		= VlStore.pGet("newPrivileges");
		userRole 		= VlStore.pGet("newUserRole");
		billcoppo 		= VlStore.pGet("newBillcoppo");
		
		var users=VlStore.pGet("phones")
		var sysAlias=VlStore.pGet("stst")
		apps=VlStore.pGet("apps")
		
	  if(mobile==="Android"){
		if(plus.runtime.version.slice(0,1) == "8" || plus.runtime.version.slice(0,1) == 8) {
			var wgtVer = plus.runtime.version; // 展示当前版本号
		} else {
			var wgtVer = "8.2069";
		}
		//检测版本更新
		var loginParam = {
			username: users,
			version	: wgtVer,
			mobile	: mobile,
			system	: sysAlias,
		} 		
		VlAjax.post({
			"port"	  : "newVersion",
			"headers" : "form",
		},loginParam,cbSLogin0);
	  }	
	}
	function imgerror(img){
		img.src="images/icon/default.png";
		img.οnerrοr=null;   //控制不要一直跳动
	}
	// 
	function cbSLogin0(res){
		// 先检是否为最新版本
		var _versionTip = res.data[0].versionNews;
		if(_versionTip !="当前版本已经是最新版本"){
		   askToUpdateApp(_versionTip, res);   
		}
	}
    function askToUpdateApp(tip, p){
    	var btnArray = ['是', '否'];
    	mui.confirm(tip, '是否更新版本', btnArray, function(e) {
    		if(e.index == 0) {
    			mui.toast("正在准备环境，请稍后！");
    			updatedVersion();
    		}
    	});
    }
	function updatedVersion() {
		var fileName = plus.runtime.appid === "vlerpfc" ? "flerp" : apps;
		var downloadPath = VlCfg.SYSURL + "File/versionUpgrade?fileName=" + fileName;
		// 版本更新 
		// var dtask = plus.downloader.createDownload(VlCfg.SYSURL + "File/versionUpgrade?fileName="+fileName, {}, function(d, status) {
		var dtask = plus.downloader.createDownload(downloadPath, {}, function(d, status) {
			if(status == 200) {
				var path = d.filename;
				// var path = plus.io.convertLocalFileSystemURL(d.filename)
				plus.runtime.install(path,{},function(e){
					mui.toast("正在打开安装界面~");
					console.log("正在打开安装界面");
				},function(e){
					alert("安装失败："+JSON.stringify(e));
					console.log("安装失败");
				});
				document.getElementById("progressbarBox").style.display = "none";
			} else {
				mui.alert('版本更新失败:' + status);
			}
	
		});
		dtask.start();
		dtask.addEventListener("statechanged", onStateChanged);
		
	}
	//监听器，用来显示实时显示下载信息
			function onStateChanged(task, status) {
				switch(task.state) {
					case 1: // 开始
						mui.toast("开始下载...");
						break;
					case 2: // 已连接到服务器
						mui.toast("链接到服务器...");
						document.getElementById("progressbarBox").style.display = "block";
						break;
					case 3: // 已接收到数据
						var progressVal = (task.downloadedSize / task.totalSize) * 100;
							jQuery("#progressbarNum").html(progressVal.toFixed(0) + '/' + '100');
							if((progressVal.toFixed(0)*1 % 5) === 0){
								mui('#demo1').progressbar({
									progress: progressVal
								}).show();
							}
							
						break;
					case 4: // 下载完成
						//mui.toast("下载完成！");
						stop();
						break;
				}
			}
	</script>
</html>