<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" type="text/css" href="../../css/common/mui.css" />
		<link rel="stylesheet" type="text/css" href="../../css/common/app.css" />
		<link rel="stylesheet" type="text/css" href="../../css/fonts/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="../../css/common/mui.picker.css" />
		<link rel="stylesheet" type="text/css" href="../../css/common/mui.poppicker.css" />
		<link rel="stylesheet" type="text/css" href="../../css/index.css" />
		<link rel="stylesheet" href="../../css/fonts/iconfont.css" />
		<style>
			body {
				font-size: 12px;
			}
			
			form {
				margin: 5px 0;
			}
			
			.mui-row {
				padding: 8px;
			}
			.spn {
				color: gray;
			}
			.list_sts {
				font-size: 12px;
				line-height: 14px;
				color: #f0ad4e;
				border: 1px solid #f0ad4e;
				border-radius: 2px;
				text-align: center;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav headerMain nodeHeader" id='head'>
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" id="goBack"></a>
			<h1 class="mui-title headText" id="header"></h1>
			<a class="mui-icon mui-icon-compose mui-pull-right" id="toEdit"></a>
			<div class="mui-row navBar nodeTopNav">
				<p class="mui-col-xs-12" id="lowerGoods">
					<a class="icon iconfont icon-shangpin1"></a>
					<span>下级商品</span>
				</p>
			</div>
		</header>
		<div class="mui-content" style="padding-top:100px;margin-top:30px">
			<div class="mui-input-group" style="padding:5px 18px 5px 18px;margin-bottom:5px;">
				<div class="mui-row"  style="display:none;">
					<span class="mui-col-xs-4 spn">上级商品：</span>
					<span class="mui-col-xs-8 spn" id="fbill_no"></span>
				</div>
				<div class="mui-row">
					<span class="mui-col-xs-4 spn">上级商品：</span>
					<span class="mui-col-xs-8 spn" id="fbill_no_name"></span>
				</div>
			</div>
			<div class="mui-input-group" style="padding:5px 18px 5px 18px;margin-bottom:5px;">
				<div class="" style="padding:0px;height:72px;">
					<div class="mui-row" style="background:;padding:0px;border-bottom:1px solid #efeff4;">
						<div class="mui-col-xs-2 mui-row" style="background:;padding:5px;margin-right:10px;">
							<img class="vdvc105 mui-col-xs-12" id="userImg" src="../../images/icon/default.png" style="padding:0px;width:60px;border:1px solid #ccc;border-radius:10px;" />
						</div>
						<div class="mui-col-xs-9 mui-row mui-pull-right" style="background:;padding-right:0;padding-left:0px;margin-left:15px;">
							<div class="list_h5 mui-col-xs-12" style="color:#242424;border-bottom:1px solid #efeff4;padding:5px 0;height:28px;">
								<span class="mui-col-xs-4 spn">商品编码：</span>
								<span class="mui-col-xs-5 spn" id="bill_id"></span>
								<span class="list_sts mui-col-xs-3 mui-pull-right" id="bill_task" style="float:right;margin-top:3px;height: 16px;width:60px;"></span>
							</div>
							<div class="list_font mui-col-xs-12" style="padding:5px 0;height:28px;">
								<span class="mui-col-xs-3 spn">商品名称：</span>
								<span class="mui-col-xs-9 spn" id="bill_name"></span>
							</div>
						</div>
					</div>
				</div>
				<div class="mui-row" style="border-bottom:1px solid #efeff4;">
					<span class="mui-col-xs-4 spn">销售价格：</span>
					<span class="mui-col-xs-8 spn" id="node_price"></span>
				</div>
				<div class="mui-row" style="border-bottom:1px solid #efeff4;display:none;">
					<span class="mui-col-xs-4 spn">销售价格：</span>
					<span class="mui-col-xs-8 spn" id="linkbd_saleprice"></span>
				</div>
				<div class="mui-row" style="border-bottom:1px solid #efeff4;">
					<span class="mui-col-xs-4 spn">销售区域：</span>
					<span class="mui-col-xs-8 spn" id="linkvd_salearea"></span>
				</div>
				<div class="mui-row" style="border-bottom:1px solid #efeff4;">
					<span class="mui-col-xs-4 spn">商品码(箱)：</span>
					<span class="mui-col-xs-8 spn" id="linkbd_bEANcode"></span>
				</div>
				<div class="mui-row lastInput" style="border-bottom:1px solid #efeff4;">
					<span class="mui-col-xs-4 spn">商品码(瓶)：</span>
					<span class="mui-col-xs-8 spn" id="linkbd_sEANcode"></span>
				</div>
				<div class="mui-row" style="border-bottom:1px solid #efeff4;">
					<span class="mui-col-xs-4 spn">规格：</span>
					<span class="mui-col-xs-8 spn" id="linkbd_spec"></span>
				</div>
				<div class="mui-row" style="border-bottom:1px solid #efeff4;">
					<span class="mui-col-xs-4 spn">产品类型：</span>
					<span class="mui-col-xs-8 spn" id="bill_bflow"></span>
				</div>
				<div class="mui-row" style="border-bottom:1px solid #efeff4;">
					<span class="mui-col-xs-4 spn">产品类别：</span>
					<span class="mui-col-xs-8 spn" id="bill_wflow"></span>
				</div>
				<div class="mui-row" style="">
					<span class="mui-col-xs-4 spn">电商类型：</span>
					<span class="mui-col-xs-8 spn" id="linkvd_ecompyte"></span>
				</div>
			</div>
			<div class="mui-input-group" style="padding:5px 18px 5px 18px;margin-bottom:5px;">
				<div class="mui-row" style="border-bottom:1px solid #efeff4;">
					<span class="mui-col-xs-4 spn">制单人：</span>
					<span class="mui-col-xs-8 spn" id="bill_userName"></span>
				</div>
				<div class="mui-row" style="border-bottom:1px solid #efeff4;display: none;">
					<span class="mui-col-xs-4 spn">制单人代码：</span>
					<span class="mui-col-xs-8 spn" id="bill_user"></span>
				</div>
				<!--<div class="mui-row" style="border-bottom:1px solid #efeff4;">
					<span class="mui-col-xs-4 spn">抄送：</span>
					<span class="mui-col-xs-8 spn" id="cc_user"></span>
				</div>-->
				<div class="mui-row">
					<span class="mui-col-xs-4 spn">制单时间：</span>
					<span class="mui-col-xs-8 spn" id="bill_date"></span>
				</div>
			</div>
		</div>
		<div class="">
			<div class="fold" id="fold">
				<p id="" class="mui-h5" style="padding-left:25px;font-size: 12px;">关联商码：<span class='state' id="linkvd_linkcom"></span><span></span></p>
				<p id="" class="mui-h5" style="padding-left:25px;font-size: 12px;">关联商品：<span class='state' id="linkvd_linkcomName"></span></p>
				<p id="" class="mui-h5" style="padding-left:25px;padding-right:25px;font-size: 12px;">
					关联时间：
					<span class='state mui-col-xs-4' id="linkvd_linkdate"></span>
					<span class="list_sts mui-col-xs-3 mui" id="linkbd_linksts" style="float:right;margin-top:3px;height: 16px;width:60px;"></span>
					<!--<span class="mui-col-xs-1" id="linkbd_linksts" style="float:right;margin-top:3px;">已关联</span>-->
				</p>
			</div>
		</div>
	</body>
	<script src="../../js/mui.min.js"></script>
	<script src="../../js/jquery-2.1.0.js"></script>
	
	<script src="../../js/md5.js"></script>
	<script src="../../js/index.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/immersed.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
		mui.init({});
		var $$ = jQuery.noConflict();
		var detailInfo = {};
		var teamBillCom;
		var teamBillComName;
		var fbill_no;
		var loginCom;
		var loginComName;
		var userbillNo;
		var userName;
		var privileges;
		var fromPage;
		mui.plusReady(function() {
			
			window.addEventListener('backAndRefreshList', function(event) {

				teamBillCom 	= event.detail.teamBillCom;		// 管理单位代码
				fbill_no 		= event.detail.fbill_no;		// fbill_no是
				teamBillComName = event.detail.teamBillComName; // 管理单位名称
				loginCom 		= event.detail.loginCom;	 	// 登录单位代码
				loginComName 	= event.detail.loginComName;	// 登录单位名称
				userbillNo 		= event.detail.userbillNo;		// 登录人的代码
				userName 		= event.detail.userName,		// 登录人的姓名
				privileges 		= event.detail.privileges,		// 当前的权限是
				fromPage 		= event.detail.fromPage,		// 从哪个页面来
				bill_no 		= event.detail.bill_no,		// 从哪个页面来
				queryparmas={
					name:'vdvc511',    
					bill_com:loginCom, 
					bill_task:"L,S,Y,YF",
					currentPage:1, 
					pageSize:1, 
					paramText:"",
					bill_no:bill_no  
				}

				searchAjax(queryparmas);
			})
			// 重写返回事件
			var oldBack = mui.back;
			mui.back = function() {
				var webview = plus.webview.getWebviewById('vdvc511_plist.html');
				webview.show();
			}
			// 获取上个页面传过来的参数
			var self = plus.webview.currentWebview();
			// 基本参数(必要)
			teamBillCom 	= self.teamBillCom; 	// 1.管理单位代码
			teamBillComName = self.teamBillComName;	// 2.管理单位名称
			fbill_no 		= self.fbill_no;		// 3.fbill_no是
			loginCom 		= self.loginCom;		// 4.登录单位代码
			loginComName 	= self.loginComName;	// 5.登录单位名称
			userbillNo 		= self.userbillNo;		// 6.登录人的代码
			userName 		= self.userName;		// 7.登录人的姓名
			privileges 		= self.privileges;		// 8.当前的权限是
			fromPage 		= self.fromPage;		// 9.从哪个页面来	

			if(fromPage=="vdvc511list") {
				detailInfo = self.detailInfo;
			}
			if(fromPage=="vdvc511edit") {
				detailInfo = self.rqsData;
				detailInfo.bill_task = "S";
				if((typeof detailInfo.bill_text) == "string"){
					detailInfo.bill_text = JSON.parse(detailInfo.bill_text);
				}
			}

			var date = new Date();
			var commit = document.getElementById("commit");
			var bill_date = vlUtils.dateToString(date);
			var rqsData = null; //提交的数据
			var inputData = null; // 表单里的数据

			//*******************结束获取每一个输入框的的值***************
			// 获取当前用户详情信息teamBillCom, 1, 1, '', detailInfo.bill_no
			queryparmas = {
				name: 'vdvc511',
				bill_com: detailInfo.bill_com,
				bill_task:"L,S,Y,YF",
				currentPage: 1,
				pageSize: 1,
				paramText: "",
				bill_no: detailInfo.bill_no
			}
			searchAjax(queryparmas);

			// 下级商品开始*******************************
			document.getElementById("lowerGoods").addEventListener("tap", function() {
				
				teamBillCom 	= detailInfo.bill_no;
				teamBillComName = detailInfo.bill_name;
				fbill_no 		= detailInfo.bill_no;
				
				mui.fire(plus.webview.getWebviewById('vdvc511_plist.html'), 'lowerDeptRefresh511plist', {
					teamBillCom 	: teamBillCom, 		// 1.管理单位代码 	// 0109改为当前li的bill_no  
					teamBillComName : teamBillComName,	// 2.管理单位名称	// 0109改为当前li的bill_name 
					fbill_no 		: fbill_no,			// 3.fbill_no是		// 0109改为当前li的bill_no 
					loginCom 		: loginCom,			// 4.登录单位代码
					loginComName 	: loginComName,		// 5.登录单位名称
					userbillNo 		: userbillNo,		// 6.登录人的代码
					userName 		: userName,			// 7.登录人的姓名
					privileges 		: privileges,		// 8.当前的权限是
					fromPage 		: "vdvc511node",	// 9.从哪个页面来
					detailInfo		: detailInfo
				});
				mui.fire(plus.webview.getWebviewById('vdvc511_list.html'), 'lowerDeptRefresh511list', {
					teamBillCom 	: teamBillCom, 		// 1.管理单位代码 	// 0109改为当前li的bill_no  
					teamBillComName : teamBillComName,	// 2.管理单位名称	// 0109改为当前li的bill_name 
					fbill_no 		: fbill_no,			// 3.fbill_no是		// 0109改为当前li的bill_no 
					loginCom 		: loginCom,			// 4.登录单位代码
					loginComName 	: loginComName,		// 5.登录单位名称
					userbillNo 		: userbillNo,		// 6.登录人的代码
					userName 		: userName,			// 7.登录人的姓名
					privileges 		: privileges,		// 8.当前的权限是
					fromPage 		: "vdvc511node",	// 9.从哪个页面来
					detailInfo		: detailInfo
				});
				mui.openWindow({
					id: 'vdvc511_plist.html'
				});
			})

			// 点击返回按钮
//			document.getElementById("goBack").addEventListener("tap", function() {
//				var oldBack = mui.back;
//				mui.back = function() {
//					var webview = plus.webview.getWebviewById('vdvc511_plist.html');
//					webview.show();
//				}
//				mui.back();
//			})

			//=============================
			// 点击编辑
			document.getElementById("toEdit").addEventListener("tap", function() {
				var billUser = document.getElementById("toEdit").getAttribute("billUser");
				var privileges = vlUtils.getStorage("newPrivileges");

				if(billUser == userbillNo || privileges == "ROOT") {
					mui.openWindow({
						url: 'vdvc511_edit.html',
						id: "vdvc511_edit.html",
						createNew: true,
						extras: {
							teamBillCom 	: teamBillCom, 		// 1.管理单位代码 	// 不变 
							teamBillComName : teamBillComName,	// 2.管理单位名称	// 不变 
							fbill_no 		: fbill_no,			// 3.fbill_no是		// 不变
							loginCom 		: loginCom,			// 4.登录单位代码
							loginComName 	: loginComName,		// 5.登录单位名称
							userbillNo 		: userbillNo,		// 6.登录人的代码
							userName 		: userName,			// 7.登录人的姓名
							privileges 		: privileges,		// 8.当前的权限是
							fromPage 		: "vdvc103node",	// 9.从哪个页面来
							detailInfo 		: detailInfo,
 							flagNew 		: "N"
						}
					})
				} else {
					mui.toast("仅制单人或管理员有此权限！");
				}
			});

			// 
			function searchAjax(queryparmas) {

				mui.ajax(systemURL + 'Find/Ddata/find', {
					data: queryparmas,
					beforeSend: function() {
						var network = true;
						checkNetState(); // 检查网络链接状态
					},
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 60000, //超时时间设置为10秒；
//					contentType: "application/x-www-form-urlencoded; charset=utf-8",
					contentType: "application/json; charset=utf-8",
					success: function(data) {
						if(data.code == 0) {
							var datas = data.data;
							if(datas.length != 0) {
								detailInfo = datas[0];
								// 去掉undefined
								if(vlUtils.isnull(datas[0].bill_text[0].linkvd_salearea)){
									datas[0].bill_text[0].linkvd_salearea = "";
								}
								if(vlUtils.isnull(datas[0].bill_text[0].linkvd_ecompyte)){
									datas[0].bill_text[0].linkvd_ecompyte = "";
								}
								// 更换页头
								document.getElementById("header").innerHTML = datas[0].bill_name;
								// 给每个输入框赋值
								document.getElementById('bill_name').innerHTML = datas[0].bill_name; //部门名称
								document.getElementById('bill_id').innerHTML = datas[0].bill_id; // 部门编码
								document.getElementById('fbill_no').innerHTML = datas[0].fbill_no; // 上级部门
								document.getElementById('bill_bflow').innerHTML = datas[0].bill_bflow; // 上级部门
								document.getElementById('bill_wflow').innerHTML = datas[0].bill_wflow; // 上级部门
								if(teamBillComName != loginComName){
									document.getElementById('fbill_no_name').innerHTML = teamBillComName; // 上级部门
								}else{
									document.getElementById('fbill_no_name').innerHTML = "ROOT"; // 上级部门
								}
								document.getElementById('linkbd_spec').innerHTML = datas[0].bill_text[0].linkbd_spec; //规格
								document.getElementById('linkbd_bEANcode').innerHTML = datas[0].bill_text[0].linkbd_bEANcode; //商品码箱
								document.getElementById('linkbd_sEANcode').innerHTML = datas[0].bill_text[0].linkbd_sEANcode; //商品码瓶
								document.getElementById('linkvd_salearea').innerHTML = datas[0].bill_text[0].linkvd_salearea; //商品码瓶
								document.getElementById('linkvd_ecompyte').innerHTML = datas[0].bill_text[0].linkvd_ecompyte; //商品码瓶
								
								// 管理员、业务员
								document.getElementById("bill_user").innerHTML = datas[0].bill_user;
								document.getElementById("bill_userName").innerHTML = datas[0].bill_userName;
//								document.getElementById("cc_user").innerHTML = datas[0].cc_user;
								document.getElementById("bill_date").innerHTML = datas[0].bill_date;
								//**********
//								document.getElementById("linkbd_saleprice").innerHTML = datas[0].bill_text[0].linkbd_saleprice; // 销售价格
//								if(document.getElementById("linkbd_saleprice").innerHTML == "undefined" || document.getElementById("linkbd_saleprice").innerHTML == undefined ){
//									document.getElementById("linkbd_saleprice").innerHTML = "";
//								}
								//
								document.getElementById("node_price").innerHTML = datas[0].node_price; // 销售价格
								if(datas[0].node_price == undefined || datas[0].node_price == "undefined"){
									document.getElementById("node_price").innerHTML = datas[0].bill_text[0].linkbd_saleprice;
								}
								
								document.getElementById("linkvd_linkdate").innerHTML = datas[0].bill_text[0].linkvd_linkdate; // 关联时间
								document.getElementById("linkvd_linkcomName").innerHTML = datas[0].bill_name; // 关联客户
								document.getElementById("linkvd_linkcom").innerHTML = datas[0].bill_text[0].linkvd_linkitem; // 关联客户编码
								//*******************
								if(datas[0].bill_text[0].linkbd_linksts == "是") {
									document.getElementById("linkbd_linksts").innerHTML = "已关联";
								}
								if(datas[0].bill_text[0].linkbd_linksts == "关联失败") {
									document.getElementById("linkbd_linksts").innerHTML = "未关联";
								}
								// 编辑按钮权限判断
								document.getElementById("toEdit").setAttribute("billUser", datas[0].bill_user);
								// 处理状态
								if(datas[0].bill_task == "S") {
									document.getElementById("bill_task").innerHTML = "待审核";
								}
								if(datas[0].bill_task == "Y") {
									document.getElementById("bill_task").innerHTML = "已审核";
								}
								if(datas[0].bill_task == "L") {
									document.getElementById("bill_task").innerHTML = "待送审";
								}

								// 下载图片
								var imgid = vlUtils.uuid('img', 4, 10);
								$$("#userImg").attr('id', imgid);
								// 判断有值的话拿到用户的id然后请求小图标
								if(!vlUtils.isnull(datas[0]["bill_id"])) {
									vlUtils.downloadicon(datas[0]["bill_id"], imgid);
								};
								// 赋值结束
							} else {
								mui.toast("未查询到数据");
							}
						}
						if(data.code == 1) {
							ajaxCode1(data.error_code,data.error_description,'../login.html');
						}
					},
					error: function(xhr, type, errorThrown) {
						console.log(xhr.responseText);
						console.log(errorThrown);
						console.log(type);
					}
				});
			}

		}); // plusReady
	</script>

</html>