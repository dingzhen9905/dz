<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>回收单审核</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../css/common/mui.css">
		<link rel="stylesheet" href="../../css/fonts/iconfont.css" />
		<style>
			.list_font {
				font-size: 10px;
				line-height: 12px;
				height: 16px;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
			}
			.list_fonts {
				font-size: 12px;
				line-height: 14px;
				margin-top:3px;
			}
			
			.list_h5 {
				font-size: 13px;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
			}
			
			.list_sts {
				margin-left:10px;
				margin-top:-3px;
				font-size: 10px;
				line-height: 14px;
				color: #f0ad4e;
				border: 1px solid #f0ad4e;
				border-radius: 2px;
				text-align: center;
			}
			
			.mui-pull-top-pocket {
				border: transparent;
			}
			
			.mui-table-view:after {
				height: 0 !important;
			}
			
			.mui-table-view:before {
				height: 0 !important;
			}
			* {
				margin: 0px;
				padding: 0px;
			}
			
			body {
				font-size: 16px;
			}
			
			ul#contList {
				width: 100%;
				background: #efeff4;
			}
			
			ul#contList li {
				margin-bottom: 10px;
			}
			
			ul.detail li {
				height: 70px;
				padding: 5px 5px;
				background: ;
				margin: 3px 10px;
			}
			
			.money{
				font-size: 10px;
			}
			.order-main-li{margin-bottom:5px;background:#fff;border-top:1px solid #E0E0E0; box-shadow: 3px 3px 3px #ccc}
			.order-imgbox{padding:5px;padding-left:0px;box-sizing:border-box;}
			.order-info-title {padding-top:1px;font-size: 13px;color:#242424;text-overflow: ellipsis;white-space: nowrap;overflow: hidden;}
			.order-info-leftbox{}
			.order-info-left {display: -webkit-box;height: 14px;margin-bottom:1px;font-size: 10px;line-height: 12px;-webkit-box-orient: vertical;-webkit-line-clamp: 2;overflow: hidden;}
			.order-info-rightbox{text-align: right;}
			.order-info-right {font-size: 12px;line-height: 14px;float: right;margin:1px auto;}
			.order-price{color:#FF5053;font-size: 14px;}
			.order-qty{font-size: 16px;color: #000000;}
			.order-statusbox{text-align:right;padding-right:10px;}
			.order-status {margin-left:10px;font-size: 10px;line-height: 14px;color: #f0ad4e;border: 1px solid #f0ad4e;border-radius: 2px;text-align: center;}
			.detail-label{padding:0px 5px 0px 50px !important;}
			.mui-row:before,
			.mui-row:after,
			.mui-table-view-cell:after,
			.mui-table-view-cell:before{
				height:0px;
			}
			input{
				top: 10px !important;
			}
			.mui-table-view-cell:hover,
			.mui-slider-cell:hover{
				background:#E0E0E0 !important;
			}
			.hide{display: none;}
			.vl-footer{position:fixed;}
			.save-btn{background: #EA6D10;font-size:16px;color: #FFFFFF !important;}
		</style>
	</head>

	<body>
		<div id="vdst316sh_list" class="mui-content mui-scroll-wrapper">
			<div id="showHint" class="mui-h5" style="padding:80px;height:300px;display:;text-align: center;background: ;display:block;border: transparent;background: ;">
				<span class="icon iconfont icon-wushuju" style="color:;font-size:100px;"></span>
				<p style="color:#000000;margin-top:10px;margin-bottom:0;border-bottom: transparent;padding-bottom:0;">未查询到相关的数据</p>
				<p style="font-size:10px;border-bottom: transparent;">可以尝试其他查询</p>
			</div>
			<div id="searching" class="mui-h5" style="padding:100px;height:300px;text-align: center;display:none;">
				<p class="mui-icon mui-icon-search" id="" style=";color:#0062cc;height:100px;line-height: 100px;font-size: 100px;"></p>
				<p style="font-size:12px;">正在搜索中......</p>
			</div>
			<div class="mui-scroll">
				<ul id="contList" class="mui-table-view mui-table-view-striped mui-table-view-condensed order-main-ul">
				</ul>
			</div>
		</div>
		<nav class="mui-bar mui-bar-tab vl-footer">
		    <a class="mui-tab-item"></a>
		    <a class="mui-tab-item"></a>
		    <a class="mui-tab-item save-btn" id="J_btn_save">
		        <span class="mui-tab-label">确 定</span>
		    </a>
		</nav>
		<script type="text/template" id="li-template">
			<li class="order-main-li mui-input-row mui-checkbox mui-right order-main-li <%=liclass%>" data-show=false style="background:#fff;">
                <label>
                    <div class="mui-slider-cell  mui-slider-handle">
                    	<div class="data-row hide"><%=rowdata%></div>
                        <div class="mui-row maintxt main-top hide">
                                <span class="mui-col-xs-7 "><%=liTitle%></span>
                                <span class="mui-col-xs-5 main-top-right"><%=liRightM%></span>
                        </div>
                        <div class="mui-row main-middle">
                            <div class="mui-col-xs-2 mui-row order-imgbox">
                                <img class="mui-col-xs-12" src="../../images/icon/default.png" id="<%=liImgId%>" />
                            </div>
                            <div class="mui-col-xs-7 order-info-leftbox">
                                <h5 class="order-info-title mui-col-xs-12 "><%=liTitle%></h5>
                                <p class="order-info-left mui-col-xs-12 "><%=liLeftM%></p>
                                <p class="order-info-left mui-col-xs-12 "><%=liLeftB%></p>
                            </div>
                            <div class="mui-col-xs-3 mui-row order-info-rightbox" style="text-align: right;">
                                <p class="order-info-right mui-col-xs-12"><%=liRightT%></p>
                                <p class="order-info-right mui-col-xs-12 money"><%=liRightM%></p>
                                <p class="order-info-right mui-col-xs-12"><%=liDate%></p>
                            </div>
                        </div>
                    </div>
                </label>
                <input name="detail" class="detail-input <%=liclass%>" style="display: <%=liclass%>;" type="checkbox" />
            </li>
		</script>

	</body>
	
	<script src="../../js/mui.min.js"></script>
	<script src="../../js/arttmpl.js"></script>
	<script src="../../js/jquery-2.1.0.js"></script>
	<script src="../../js/md5.js"></script>
	<script src="../../js/vlindex.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
		mui.init({
			pullRefresh: {
				container: '#vdst316sh_list',
				down: {
					callback: pulldownRefresh
				},
				up: {
					height: 200,
					contentnomore: '没有更多数据了',
					contentrefresh: '正在加载...',
					callback: pullupRefresh
				}
			}
		});
		var teamBillCom,teamBillComName,userbillNo,loginCom,loginComName,fromPage,userName,privileges,userInfo,system,
		pageSize = 10,
		search = '',
		_p = {},
		pager = {},
		activeType = "001",
		activeTask = "",
		activeText = "待审核",
		activeClass = "nearbyli",
		activeSearch,activeDlvno,
		bill_ipaddr = 0,
		bill_gpsaddr = 0,
		pageTitle,commonParams,
		oUl = document.getElementById("contList"),
		_oTrueFalse ={"true": true, "false": false},
		aSelected=[],
		oTask = {
			"vdst315" : {
				"task" : "VR_vdst316_query_13",
				"title" : "配送员",
			},
			"vdst316" :  {
				"task" : "VR_vdst316_query_09",
				"title" : "业务员/配送员",
			}
		};
		mui.plusReady(function() {
			var self 		= plus.webview.currentWebview().parent();
			teamBillCom 	= self.teamBillCom;
			teamBillComName = self.teamBillComName;
			userbillNo 		= self.userbillNo;
			loginCom 		= self.loginCom;
			loginComName 	= self.loginComName;
			fromPage 		= self.fromPage;
			userName 		= self.userName;
			privileges 		= self.privileges;
			pageTitle 		= self.pageTitle;
			commonParams 	= self.commonParams;
			userInfo 		= JSON.parse(VlStore.pGet("user"));
			system 			= userInfo.com_linkvd_userCom;
			activeTask = oTask[commonParams]['task'];

			document.addEventListener('subpage133list', function(e) { ecChangeTab(e) });
			document.getElementById("J_btn_save").addEventListener('tap', eBtnSave, false);
			mui('#contList').on('change', 'input.block', function(e) {eaMchange(this)});
			mui('#contList').on('tap', 'li.none', function(e) {eTapLi(this)});
			
		}); 
		function pulldownRefresh() {
			if(VlUtils.isnull(activeDlvno)){
				mui.toast("请先选择“"+oTask[commonParams]['title']+"”~");
				mui('#vdst316sh_list').pullRefresh().endPulldownToRefresh();
				return;
			}
			document.getElementById("contList").innerHTML = "";
			document.getElementById("showHint").style.display = "none";
			plus.nativeUI.showWaiting("正在查询数据..."); 
			_p = findData();
			VlAjax.post({"port" : "active","headers" : "json","isFirst" : true}, _p, sCBfind);
			mui('#vdst316sh_list').pullRefresh().endPulldownToRefresh(); //下拉完成后可以再次执行下拉刷新
		}
		
		function pullupRefresh() {
			if(_p.currentPage < pager.totalPage) {
				_p.currentPage = _p.currentPage + 1;
			} else {
				plus.nativeUI.toast("~没有更多啦~", {
					'verticalAlign': "middle"
				});
				mui('#vdst316sh_list').pullRefresh().endPullupToRefresh();
				return;
			}
			plus.nativeUI.showWaiting("正在查询数据..."); 
			VlAjax.post({"port" : "active","headers" : "json","isFirst" : false}, _p, sCBfind);
			mui('#vdst316sh_list').pullRefresh().endPullupToRefresh();
		}
		function eBtnSave(){
			var str = aSelected.join(",");
			if(VlUtils.isnull(str)){
				mui.toast("请先选择内容~");
				return;
			}else{
				VlPage.beforeOpen('vdst316sh_edit.html');
				mui.openWindow({
					url : "vdst316sh_edit.html",
					id : "vdst316sh_edit.html",
					extras :{
						activeDlvname : activeSearch,
						activeDlvno : activeDlvno,
						sBno : str,
						teamBillCom : teamBillCom,
						teamBillComName : teamBillComName,
						userbillNo : userbillNo,
						commonParams : commonParams,
					}
				})
			}
		}
		function ecChangeTab(event) {
			activeTask = event.detail.activeTask;
			activeType = event.detail.activeType;
			activeText = event.detail.activeText;
			activeClass = event.detail.activeClass;
			activeRequire = event.detail.activeRequire;
			activeSearch = event.detail.activeSearch;
			search = activeType == "001" ? "" : activeSearch;
			activeDlvno = event.detail.activeDlvno;
			//
			mui(".vl-footer")[0].style.display = activeType == "001" ? "block" : "none";
			document.getElementById("showHint").style.display = "none";
			document.getElementById("searching").style.display = "block";
			//
			oUl.innerHTML = '';
			if(activeRequire == "true" && VlUtils.isnull(activeDlvno)){
				mui.toast("请先选择“"+oTask[commonParams]['title']+"”~");
				document.getElementById("showHint").style.display = "block";
				document.getElementById("searching").style.display = "none";
				return;
			}
			plus.nativeUI.showWaiting("正在查询数据..."); 
			_p = findData();
			VlAjax.post({"port" : "active","headers" : "json","isFirst" : true}, _p, sCBfind);
		}
		function eTapLi(self){
			var li = jQuery(self.parentNode);
				dataRow = JSON.parse(li.find(".data-row").html());
			VlPage.beforeOpen('vdst316sh_node.html');
			mui.openWindow({
				url : "vdst316sh_node.html",
				id : "vdst316sh_node.html",
				extras :{
					dataRow : dataRow,
					teamBillCom : teamBillCom,
					teamBillComName : teamBillComName,
					userbillNo : userbillNo,
					commonParams : commonParams,
				}
			})
		}
		function eaMchange(self){
			var li = jQuery(self.parentNode),
				dataRow = JSON.parse(li.find(".data-row").html()),
				isshow = li.attr("data-show");
			li.attr("data-show",!_oTrueFalse[isshow]);
			isshow = !_oTrueFalse[isshow];

			changeSelectedData(dataRow["内容"]["单号"], isshow);
		}
		function changeSelectedData(bno,isSelected){
			var bno = "'" + bno + "'";
			var idx;
			if(isSelected){
				aSelected.push(bno);
			}else{
				idx = aSelected.indexOf(bno);
				aSelected.splice(idx, 1);
			}
		}
		
		function findData(){
			var _p = { // 默认我的客户001
				name: 'msvr',
				bill_com	: teamBillCom,
				bill_user	: activeDlvno,
				bill_task	: activeTask, 
				bill_qtask	: activeText, 
				bill_title  : search,
				currentPage	: 1,
				pageSize	: pageSize,
				paramText	: ''
			}
//			console.log(JSON.stringify(_p))
			return _p;
		}
		var _oContent = {
			"单号":"",
			"制单人":"",
		}
		var _oAddr = {
			"linkbd_linkprov":"",
			"linkbd_linkstreet": "",
			"linkvd_corraddr":"",
			"linkbd_lngposition":""
		}
		function st315listAdapter(data){
        	var oData = {};
			for(var k in data) {
				oData[k.slice(0, 2)] = data[k];
			}
			var _content = oData['内容'] = (oData['内容'].indexOf('{') > -1) ? JSON.parse(oData['内容']) : _oContent;
        	return {
        		"liclass"   : activeType == "001" ? "block" : "none",
				"rowdata" 	: JSON.stringify(oData),
				"addiClass" : "nearbyli",
				"liTitle" 	: oData["标题"],
				"liDate" 	: oData["日期"].slice(5,16),
				"liStatus" 	: "",
				"liImgId" 	: oData["内容"]['单号'],
				"liImgName" : oData["图片"],
				
				"liLeftM" 	: oData["指令"],
				"liLeftB" 	: "",
				
				"liRightT" 	: oData['内容']['制单人'],
				"liRightM" 	: "",
				"liRightB" 	: "",
			}
	    }
		function sCBfind(data,type){
			pager = data.page;
			document.getElementById("showHint").style.display = "none";
			var contList = document.getElementById("contList");
			if(data.data.length != 0) {
				var html = '';
				for(var i = 0; i < data.data.length; i++) {
					if(type&&i==0){
						contList.innerHTML="";
						document.getElementById("searching").style.display = "none";
					}
					var _rowd = st315listAdapter(data.data[i]);
					var source = document.getElementById('li-template').innerHTML;
		            var render = template.compile(source);
		            html += render(_rowd);
		            VlAjax.dlIcon(_rowd.liImgName, _rowd.liImgId, VlTools.setImg);
				}
				jQuery("#contList").append(html);
			} else { // 如果没有长度说明没有数据，提示没有数据
//				mui.toast("未查询到数据~")
				document.getElementById("contList").innerHTML = '';
				document.getElementById("searching").style.display = "none";
				document.getElementById("showHint").style.display = "block";
			}
			plus.nativeUI.closeWaiting();
		}
	</script>

</html>